services:
  backend:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.backend
    ports:
      - "8000:8000"
    env_file:
      - ../.env
    environment:
      # Persist DB + data under mounted /app/data
      DATABASE_URL: sqlite:////app/data/processed/cgda.db
      DATA_RAW_DIR: /app/data/raw
      DATA_RAW2_DIR: /app/data/raw2
      DATA_PROCESSED_DIR: /app/data/processed
      DATA_RUNS_DIR: /app/data/runs
      DATA_OUTPUTS_DIR: /app/data/outputs
      DATA_PREPROCESS_DIR: /app/data/preprocess
      DATA_STAGE_DIR: /app/data/stage_data
      DATA_AI_OUTPUTS_DIR: /app/data/ai_outputs
      SAMPLE_CSV_PATH: /app/data/raw/sample_grievances.csv
      # For real NMMC files dropped into data/raw, keep seeding off to avoid mixing demo data.
      SEED_SAMPLE_DATA: "false"
      # Some keys do not have access to "flash-lite" models (403). Use a broadly available fallback.
      GEMINI_MODEL_FALLBACK: gemini-2.0-flash
      # Keep false for normal use; set true only if you intentionally want to wipe and recreate the SQLite DB.
      RECREATE_DB_ON_STARTUP: "false"
      # For production, set CORS_ORIGINS to your deployed frontend origin (or use same-origin via a reverse proxy).
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
      # Free-tier Gemini config is sourced from ../.env (only manual step is pasting GEMINI_API_KEY there)
      # Temporary: disable login/JWT checks for internal demo/iframe embedding
      DISABLE_AUTH: ${DISABLE_AUTH:-true}
    volumes:
      - ../data:/app/data
      # Also mount the env file so python-dotenv inside the container can read it
      - ../.env:/app/.env:ro

  frontend:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.frontend
      args:
        # IMPORTANT: This value is baked into the frontend bundle at build time.
        # For local dev it's localhost; for a server deployment set VITE_API_BASE_URL to your backend public URL
        # (or a same-origin proxy path like /api).
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8000}
    ports:
      - "3000:80"
    depends_on:
      - backend


